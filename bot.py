from keep_alive import keep_alive
keep_alive()

from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, CallbackQueryHandler
import random
import time
import os
from datetime import datetime, timedelta
from pymongo import MongoClient

# --- –ù–ê–°–¢–†–û–ô–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• ---
MONGO_URL = os.getenv('MONGO_URL') 

if MONGO_URL:
    try:
        cluster = MongoClient(MONGO_URL)
        db = cluster["bible_bot_db"]
        collection = db["leaderboard"]
        battles_collection = db["battles"]
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {e}")
        collection = None
        battles_collection = None
else:
    print("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –∑–∞–¥–∞–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è MONGO_URL.")
    collection = None
    battles_collection = None

# –°–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
CHOOSING_LEVEL, ANSWERING, BATTLE_WAITING, BATTLE_ANSWERING = range(4)

# ==========================================
# üü¢ –õ–Å–ì–ö–ò–ô –£–†–û–í–ï–ù–¨ (15 –≤–æ–ø—Ä–æ—Å–æ–≤)
# ==========================================
easy_questions = [
    {
        "question": "–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –ü–µ—Ä–≤–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –ü–µ—Ç—Ä–∞?",
        "options": ["–ê–ø–æ—Å—Ç–æ–ª –ü–∞–≤–µ–ª", "–ê–ø–æ—Å—Ç–æ–ª –ü–µ—Ç—Ä", "–ê–ø–æ—Å—Ç–æ–ª –ò–æ–∞–Ω–Ω", "–ê–ø–æ—Å—Ç–æ–ª –ò–∞–∫–æ–≤"],
        "correct": 1,
        "explanation": "–ê–≤—Ç–æ—Ä–æ–º –ø–æ—Å–ª–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è –∞–ø–æ—Å—Ç–æ–ª –ü–µ—Ç—Ä."
    },
    {
        "question": "–í –∫–∞–∫–æ–º –≥–æ–¥—É –ø—Ä–∏–º–µ—Ä–Ω–æ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –ø–æ—Å–ª–∞–Ω–∏–µ?",
        "options": ["30-33 –≥–≥.", "50-55 –≥–≥.", "62-63 –≥–≥.", "70-75 –≥–≥."],
        "correct": 2,
        "explanation": "–ü–æ—Å–ª–∞–Ω–∏–µ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –æ–∫–æ–ª–æ 62-63 –≥–≥. –Ω.—ç."
    },
    {
        "question": "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏–ª—Å—è –ü–µ—Ç—Ä, –∫–æ–≥–¥–∞ –ø–∏—Å–∞–ª –ø–æ—Å–ª–∞–Ω–∏–µ?",
        "options": ["–í –ò–µ—Ä—É—Å–∞–ª–∏–º–µ", "–í –†–∏–º–µ", "–í –ê–Ω—Ç–∏–æ—Ö–∏–∏", "–í –ï—Ñ–µ—Å–µ"],
        "correct": 1,
        "explanation": "–ü–µ—Ç—Ä –Ω–∞—Ö–æ–¥–∏–ª—Å—è –≤ –†–∏–º–µ."
    },
    {
        "question": "–ö–∞–∫ –ü–µ—Ç—Ä —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏ –Ω–∞–∑–≤–∞–ª –†–∏–º –≤ –ø–æ—Å–ª–∞–Ω–∏–∏?",
        "options": ["–ï–≥–∏–ø–µ—Ç", "–í–∞–≤–∏–ª–æ–Ω", "–°–æ–¥–æ–º", "–ù–∏–Ω–µ–≤–∏—è"],
        "correct": 1,
        "explanation": "–ü–µ—Ç—Ä –Ω–∞–∑–≤–∞–ª –†–∏–º '–í–∞–≤–∏–ª–æ–Ω–æ–º' (1 –ü–µ—Ç. 5:13)."
    },
    {
        "question": "–ö–æ–º—É –±—ã–ª–æ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ –ø–æ—Å–ª–∞–Ω–∏–µ?",
        "options": ["–†–∏–º—Å–∫–∏–º —Ö—Ä–∏—Å—Ç–∏–∞–Ω–∞–º", "–ò–µ—Ä—É—Å–∞–ª–∏–º—Å–∫–æ–π —Ü–µ—Ä–∫–≤–∏", "–•—Ä–∏—Å—Ç–∏–∞–Ω–∞–º –ú–∞–ª–æ–π –ê–∑–∏–∏", "–í—Å–µ–º —è–∑—ã—á–Ω–∏–∫–∞–º"],
        "correct": 2,
        "explanation": "–ü–æ—Å–ª–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ —Ö—Ä–∏—Å—Ç–∏–∞–Ω–∞–º –ú–∞–ª–æ–π –ê–∑–∏–∏."
    },
    {
        "question": "–ö–∞–∫–æ–≤–∞ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –ø–æ—Å–ª–∞–Ω–∏—è?",
        "options": ["–û—Å—É–¥–∏—Ç—å –ª–∂–µ—É—á–∏—Ç–µ–ª–µ–π", "–£–∫—Ä–µ–ø–∏—Ç—å –≤ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è—Ö", "–û–±—ä—è—Å–Ω–∏—Ç—å –¥–æ–∫—Ç—Ä–∏–Ω—ã", "–°–æ–±—Ä–∞—Ç—å –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è"],
        "correct": 1,
        "explanation": "–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —É–∫—Ä–µ–ø–∏—Ç—å –≤–µ—Ä—É—é—â–∏—Ö –≤ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è—Ö."
    },
    {
        "question": "–ß–µ—Ä–µ–∑ —á—Ç–æ –ë–æ–≥ –≤–æ–∑—Ä–æ–¥–∏–ª –Ω–∞—Å –∫ –∂–∏–≤–æ–º—É —É–ø–æ–≤–∞–Ω–∏—é? (1 –ü–µ—Ç. 1:3)",
        "options": ["–ß–µ—Ä–µ–∑ –∫—Ä–µ—â–µ–Ω–∏–µ", "–ß–µ—Ä–µ–∑ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ –•—Ä–∏—Å—Ç–∞", "–ß–µ—Ä–µ–∑ –≤–µ—Ä—É", "–ß–µ—Ä–µ–∑ –°–ª–æ–≤–æ –ë–æ–∂—å–µ"],
        "correct": 1,
        "explanation": "–ë–æ–≥ –≤–æ–∑—Ä–æ–¥–∏–ª –Ω–∞—Å –≤–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ–º –ò–∏—Å—É—Å–∞ –•—Ä–∏—Å—Ç–∞."
    },
    {
        "question": "–ö–∞–∫–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ –æ–∂–∏–¥–∞–µ—Ç –≤–µ—Ä—É—é—â–∏—Ö? (1 –ü–µ—Ç. 1:4)",
        "options": ["–ó–µ–º–Ω–æ–µ –±–æ–≥–∞—Ç—Å—Ç–≤–æ", "–ù–µ—Ç–ª–µ–Ω–Ω–æ–µ, —á–∏—Å—Ç–æ–µ, –Ω–µ—É–≤—è–¥–∞–µ–º–æ–µ", "–î–æ–ª–≥–∞—è –∂–∏–∑–Ω—å", "–í–ª–∞—Å—Ç—å –Ω–∞–¥ –Ω–∞—Ä–æ–¥–∞–º–∏"],
        "correct": 1,
        "explanation": "–í–µ—Ä—É—é—â–∏—Ö –æ–∂–∏–¥–∞–µ—Ç –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ –Ω–µ—Ç–ª–µ–Ω–Ω–æ–µ, —á–∏—Å—Ç–æ–µ, –Ω–µ—É–≤—è–¥–∞–µ–º–æ–µ."
    },
    {
        "question": "–ö–∞–∫ –≤–µ—Ä—É—é—â–∏–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ —Å–ø–∞—Å–µ–Ω–∏—é? (1 –ü–µ—Ç. 1:5)",
        "options": ["–ü–µ—Ä–µ–Ω–æ—Å—è —Å—Ç—Ä–∞–¥–∞–Ω–∏—è", "–°–∏–ª–æ—é –ë–æ–∂–∏–µ–π —á–µ—Ä–µ–∑ –≤–µ—Ä—É", "–ß–µ—Ä–µ–∑ –ü—Ä–∏—á–∞—Å—Ç–∏–µ", "–î–æ–±—Ä—ã–º–∏ –¥–µ–ª–∞–º–∏"],
        "correct": 1,
        "explanation": "–í–µ—Ä—É—é—â–∏–µ —Å–∏–ª–æ—é –ë–æ–∂–∏–µ—é —á–µ—Ä–µ–∑ –≤–µ—Ä—É —Å–æ–±–ª—é–¥–∞–µ–º—ã –∫–æ —Å–ø–∞—Å–µ–Ω–∏—é."
    },
    {
        "question": "–ö —á–µ–º—É –ø—Ä–∏–∑—ã–≤–∞–µ—Ç –ü–µ—Ç—Ä –≤–µ—Ä—É—é—â–∏—Ö? (1 –ü–µ—Ç. 1:15-16)",
        "options": ["–ö –±–æ–≥–∞—Ç—Å—Ç–≤—É", "–ö —Å–≤—è—Ç–æ—Å—Ç–∏", "–ö —Ç–µ—Ä–ø–µ–Ω–∏—é", "–ö –∑–Ω–∞–Ω–∏—é"],
        "correct": 1,
        "explanation": "'–ë—É–¥—å—Ç–µ —Å–≤—è—Ç—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ø —Å–≤—è—Ç'."
    },
    {
        "question": "–ö–∞–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å –≤–º–µ—Å—Ç–æ –†–∏–º–∞?",
        "options": ["–°–∏–æ–Ω", "–í–∞–≤–∏–ª–æ–Ω", "–ï–≥–∏–ø–µ—Ç", "–ê—Ñ–∏–Ω—ã"],
        "correct": 1,
        "explanation": "–†–∏–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏ –Ω–∞–∑—ã–≤–∞–ª—Å—è –í–∞–≤–∏–ª–æ–Ω–æ–º."
    },
    {
        "question": "–ö—Ç–æ –±—ã–ª –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤–æ –≤—Ä–µ–º—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å–ª–∞–Ω–∏—è?",
        "options": ["–ê–≤–≥—É—Å—Ç", "–ù–µ—Ä–æ–Ω", "–¢—Ä–∞—è–Ω", "–ö–ª–∞–≤–¥–∏–π"],
        "correct": 1,
        "explanation": "–í–æ –≤—Ä–µ–º—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª –ù–µ—Ä–æ–Ω."
    },
    {
        "question": "–ß—Ç–æ –∏—Å–ø—ã—Ç—ã–≤–∞–ª–∏ —Ö—Ä–∏—Å—Ç–∏–∞–Ω–µ –ú–∞–ª–æ–π –ê–∑–∏–∏?",
        "options": ["–ë–æ–≥–∞—Ç—Å—Ç–≤–æ", "–ì–æ–Ω–µ–Ω–∏—è", "–ü–æ–ª–Ω—É—é —Å–≤–æ–±–æ–¥—É", "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫—É—é –≤–ª–∞—Å—Ç—å"],
        "correct": 1,
        "explanation": "–•—Ä–∏—Å—Ç–∏–∞–Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–ª–∏ –≥–æ–Ω–µ–Ω–∏—è –∏ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è."
    },
    {
        "question": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–≥–∏–æ–Ω, –∫—É–¥–∞ –±—ã–ª–∏ —Ä–∞—Å—Å–µ—è–Ω—ã –≤–µ—Ä—É—é—â–∏–µ?",
        "options": ["–ò—É–¥–µ—è", "–ú–∞–ª–∞—è –ê–∑–∏—è", "–ï–≥–∏–ø–µ—Ç", "–ì–∞–ª–ª–∏—è"],
        "correct": 1,
        "explanation": "–í–µ—Ä—É—é—â–∏–µ –∂–∏–ª–∏ –≤ –ø—Ä–æ–≤–∏–Ω—Ü–∏—è—Ö –ú–∞–ª–æ–π –ê–∑–∏–∏."
    },
    {
        "question": "–ß—Ç–æ –ü–µ—Ç—Ä –Ω–∞–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º –Ω–∞–¥–µ–∂–¥—ã?",
        "options": ["–ó–∞–∫–æ–Ω", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ –•—Ä–∏—Å—Ç–∞", "–î–µ–ª–∞", "–ú—É–¥—Ä–æ—Å—Ç—å"],
        "correct": 1,
        "explanation": "–û—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–¥—ã ‚Äî –≤–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–µ –ò–∏—Å—É—Å–∞ –•—Ä–∏—Å—Ç–∞."
    }
]

# ==========================================
# üü° –°–†–ï–î–ù–ò–ô –£–†–û–í–ï–ù–¨ (15 –≤–æ–ø—Ä–æ—Å–æ–≤)
# ==========================================
medium_questions = [
    {
        "question": "–ü–æ—á–µ–º—É –ü–µ—Ç—Ä –Ω–∞–∑–≤–∞–ª –†–∏–º '–í–∞–≤–∏–ª–æ–Ω–æ–º'?",
        "options": ["–ú–µ—Ç–∞—Ñ–æ—Ä–∞ —è–∑—ã—á–µ—Å–∫–æ–π –≤–ª–∞—Å—Ç–∏", "–†–∏–º –æ—Å–Ω–æ–≤–∞–Ω –≤–∞–≤–∏–ª–æ–Ω—è–Ω–∞–º–∏", "–ü–µ—Ç—Ä –æ—à–∏–±—Å—è", "–û–Ω –±—ã–ª –≤ –í–∞–≤–∏–ª–æ–Ω–µ"],
        "correct": 0,
        "explanation": "–í–∞–≤–∏–ª–æ–Ω ‚Äî —Å–∏–º–≤–æ–ª —è–∑—ã—á–µ—Å–∫–æ–π –≤–ª–∞—Å—Ç–∏."
    },
    {
        "question": "–ü—Ä–∏ –∫–∞–∫–æ–º –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–µ –Ω–∞—á–∞–ª–∏—Å—å –º–∞—Å—Å–æ–≤—ã–µ –≥–æ–Ω–µ–Ω–∏—è?",
        "options": ["–ö–ª–∞–≤–¥–∏–π", "–ù–µ—Ä–æ–Ω", "–î–æ–º–∏—Ü–∏–∞–Ω", "–¢—Ä–∞—è–Ω"],
        "correct": 1,
        "explanation": "–ú–∞—Å—Å–æ–≤—ã–µ –≥–æ–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª–∏—Å—å –ø—Ä–∏ –ù–µ—Ä–æ–Ω–µ –≤ 64 –≥."
    },
    {
        "question": "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –≥—Ä–µ—á–µ—Å–∫–æ–µ 'œÄœÅœåŒ≥ŒΩœâœÉŒπœÇ' (–ø—Ä–µ–¥–≤–µ–¥–µ–Ω–∏–µ)?",
        "options": ["–ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–µ–¥–≤–∏–¥–µ–Ω–∏–µ", "–ò–∑–±—Ä–∞–Ω–∏–µ –ø–æ –∑–∞–≤–µ—Ç–Ω–æ–π –ª—é–±–≤–∏", "–ó–Ω–∞–Ω–∏–µ –±—É–¥—É—â–µ–≥–æ", "–ë–æ–∂—å—è –º—É–¥—Ä–æ—Å—Ç—å"],
        "correct": 1,
        "explanation": "–û–∑–Ω–∞—á–∞–µ—Ç –∏–∑–±—Ä–∞–Ω–∏–µ –ø–æ –∑–∞–≤–µ—Ç–Ω–æ–π –ª—é–±–≤–∏."
    },
    {
        "question": "–ö—Ç–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞ –æ —Å–ø–∞—Å–µ–Ω–∏–∏? (1 –ü–µ—Ç. 1:10)",
        "options": ["–ê–ø–æ—Å—Ç–æ–ª—ã", "–ü—Ä–æ—Ä–æ–∫–∏", "–ê–Ω–≥–µ–ª—ã", "–ü–µ—Ä–≤–æ—Å–≤—è—â–µ–Ω–Ω–∏–∫–∏"],
        "correct": 1,
        "explanation": "–ò–∑—ã—Å–∫–∞–Ω–∏—è –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ä–æ–∫–æ–≤."
    },
    {
        "question": "–ß—Ç–æ —É–∫–∞–∑—ã–≤–∞–ª –î—É—Ö –•—Ä–∏—Å—Ç–æ–≤ –≤ –ø—Ä–æ—Ä–æ–∫–∞—Ö? (1 –ü–µ—Ç. 1:11)",
        "options": ["–¢–æ–ª—å–∫–æ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è", "–¢–æ–ª—å–∫–æ —Å–ª–∞–≤—É", "–°—Ç—Ä–∞–¥–∞–Ω–∏—è –∏ —Å–ª–∞–≤—É", "–ö–æ–Ω–µ—Ü –º–∏—Ä–∞"],
        "correct": 2,
        "explanation": "–ü—Ä–µ–¥–≤–æ–∑–≤–µ—â–∞–ª —Å—Ç—Ä–∞–¥–∞–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥—É—é—â—É—é —Å–ª–∞–≤—É."
    },
    {
        "question": "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç '–ø—Ä–µ–ø–æ—è—Å–∞—Ç—å —á—Ä–µ—Å–ª–∞ —É–º–∞'? (1 –ü–µ—Ç. 1:13)",
        "options": ["–ú–æ–ª–∏—Ç—å—Å—è —É—Å–µ—Ä–¥–Ω–µ–µ", "–ë—ã—Ç—å –¥—É—Ö–æ–≤–Ω–æ —Å–æ–±—Ä–∞–Ω–Ω—ã–º", "–ò–∑—É—á–∞—Ç—å –ü–∏—Å–∞–Ω–∏–µ", "–ü–æ—Å—Ç–∏—Ç—å—Å—è"],
        "correct": 1,
        "explanation": "–û–±—Ä–∞–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–µ–π—Å—Ç–≤–∏—é."
    },
    {
        "question": "–° —á–µ–º —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è –∏—Å–ø—ã—Ç–∞–Ω–∏–µ –≤–µ—Ä—ã? (1 –ü–µ—Ç. 1:7)",
        "options": ["–° –æ—á–∏—â–µ–Ω–∏–µ–º —Å–µ—Ä–µ–±—Ä–∞", "–° –æ—á–∏—â–µ–Ω–∏–µ–º –∑–æ–ª–æ—Ç–∞ –æ–≥–Ω–µ–º", "–° –æ–≥—Ä–∞–Ω–∫–æ–π –∞–ª–º–∞–∑–∞", "–° –∑–∞–∫–∞–ª–∏–≤–∞–Ω–∏–µ–º —Å—Ç–∞–ª–∏"],
        "correct": 1,
        "explanation": "–í–µ—Ä–∞ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –∑–æ–ª–æ—Ç–æ –æ–≥–Ω—ë–º."
    },
    {
        "question": "–û—Ç–∫—É–¥–∞ –≤–∑—è—Ç–∞ —Ü–∏—Ç–∞—Ç–∞ '–±—É–¥—å—Ç–µ —Å–≤—è—Ç—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ø —Å–≤—è—Ç'?",
        "options": ["–ò—Å—Ö–æ–¥", "–õ–µ–≤–∏—Ç", "–í—Ç–æ—Ä–æ–∑–∞–∫–æ–Ω–∏–µ", "–ü—Å–∞–ª–º—ã"],
        "correct": 1,
        "explanation": "–¶–∏—Ç–∞—Ç–∞ –≤–∑—è—Ç–∞ –∏–∑ –∫–Ω–∏–≥–∏ –õ–µ–≤–∏—Ç."
    },
    {
        "question": "–ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª—å—é –≤–µ—Ä—ã? (1 –ü–µ—Ç. 1:9)",
        "options": ["–ë–æ–≥–∞—Ç—Å—Ç–≤–æ", "–ó–¥–æ—Ä–æ–≤—å–µ", "–°–ø–∞—Å–µ–Ω–∏–µ –¥—É—à", "–ú—É–¥—Ä–æ—Å—Ç—å"],
        "correct": 2,
        "explanation": "–î–æ—Å—Ç–∏–≥–∞—è –≤–µ—Ä–æ—é —Å–ø–∞—Å–µ–Ω–∏—è –¥—É—à."
    },
    {
        "question": "–ö—Ç–æ –∂–µ–ª–∞–µ—Ç –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç—å –≤ —Ç–∞–π–Ω—É —Å–ø–∞—Å–µ–Ω–∏—è? (1 –ü–µ—Ç. 1:12)",
        "options": ["–î–µ–º–æ–Ω—ã", "–ê–Ω–≥–µ–ª—ã", "–õ—é–¥–∏", "–ü—Ä–æ—Ä–æ–∫–∏"],
        "correct": 1,
        "explanation": "–í–æ —á—Ç–æ –∂–µ–ª–∞—é—Ç –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç—å –ê–Ω–≥–µ–ª—ã."
    },
    {
        "question": "–ü–æ—á–µ–º—É –ü–µ—Ç—Ä –Ω–µ —É–ø–æ–º–∏–Ω–∞–ª –≥–æ–Ω–µ–Ω–∏—è –ù–µ—Ä–æ–Ω–∞?",
        "options": ["–û–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å", "–ï—â—ë –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å", "–ù–µ –∑–Ω–∞–ª –æ –Ω–∏—Ö", "–ë—ã–ª–∏ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏"],
        "correct": 1,
        "explanation": "–ü–∏—Å—å–º–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –¥–æ –Ω–∞—á–∞–ª–∞ –≥–æ–Ω–µ–Ω–∏–π –ù–µ—Ä–æ–Ω–∞."
    },
    {
        "question": "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å –í–∞–≤–∏–ª–æ–Ω–æ–º?",
        "options": ["–ò–µ—Ä—É—Å–∞–ª–∏–º", "–†–∏–º", "–ê–Ω—Ç–∏–æ—Ö–∏—è", "–ö–æ—Ä–∏–Ω—Ñ"],
        "correct": 1,
        "explanation": "–í–∞–≤–∏–ª–æ–Ω ‚Äî —Å–∏–º–≤–æ–ª –†–∏–º–∞."
    },
    {
        "question": "–ö—Ç–æ, –ø–æ —Ç—Ä–∞–¥–∏—Ü–∏–∏, –ø–æ–≥–∏–± –≤ –†–∏–º–µ?",
        "options": ["–ò–æ–∞–Ω–Ω", "–ü–µ—Ç—Ä", "–õ—É–∫–∞", "–ú–∞—Ä–∫"],
        "correct": 1,
        "explanation": "–ê–ø–æ—Å—Ç–æ–ª –ü–µ—Ç—Ä —É–º–µ—Ä –≤ –†–∏–º–µ."
    },
    {
        "question": "–ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è?",
        "options": ["–°—Ç–∏–ª—å –ø–∏—Å—å–º–∞", "–û–ø–∞—Å–Ω–æ—Å—Ç—å –≥–æ–Ω–µ–Ω–∏–π", "–¢—Ä–∞–¥–∏—Ü–∏–∏", "–ü–µ—Ä–µ–≤–æ–¥"],
        "correct": 1,
        "explanation": "–ß—Ç–æ–±—ã –Ω–µ –ø–æ–¥–≤–µ—Ä–≥–∞—Ç—å —Ö—Ä–∏—Å—Ç–∏–∞–Ω –æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
    },
    {
        "question": "–ö–∞–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∫ –¥–∞—Ç–∏—Ä—É–µ—Ç –ø–∏—Å—å–º–æ 62‚Äì63 –≥–≥.?",
        "options": ["–ò–æ—Å–∏—Ñ –§–ª–∞–≤–∏–π", "–¢–æ–º–∞—Å –®—Ä–∞–π–Ω–µ—Ä", "–ï–≤—Å–µ–≤–∏–π", "–ê–≤–≥—É—Å—Ç–∏–Ω"],
        "correct": 1,
        "explanation": "–¢–æ–º–∞—Å –®—Ä–∞–π–Ω–µ—Ä –¥–∞—Ç–∏—Ä—É–µ—Ç –ø–∏—Å—å–º–æ 62‚Äì63 –≥–≥."
    }
]

# ==========================================
# üî¥ –°–õ–û–ñ–ù–´–ô –£–†–û–í–ï–ù–¨ (15 –≤–æ–ø—Ä–æ—Å–æ–≤)
# ==========================================
hard_questions = [
    {
        "question": "–ö–∞–∫–∏–µ —Ç—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è –¢—Ä–æ–∏—Ü—ã –æ–ø–∏—Å–∞–Ω—ã –≤ 1 –ü–µ—Ç. 1:2?",
        "options": [
            "–¢–≤–æ—Ä–µ–Ω–∏–µ, –∏—Å–∫—É–ø–ª–µ–Ω–∏–µ, –æ—Å–≤—è—â–µ–Ω–∏–µ",
            "–ü—Ä–µ–¥–≤–µ–¥–µ–Ω–∏–µ –û—Ç—Ü–∞, –æ—Å–≤—è—â–µ–Ω–∏–µ –î—É—Ö–∞, –æ–∫—Ä–æ–ø–ª–µ–Ω–∏–µ –∫—Ä–æ–≤—å—é",
            "–ò–∑–±—Ä–∞–Ω–∏–µ, –ø—Ä–∏–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ—Å–ª–∞–≤–ª–µ–Ω–∏–µ",
            "–í–µ—Ä–∞, –Ω–∞–¥–µ–∂–¥–∞, –ª—é–±–æ–≤—å"
        ],
        "correct": 1,
        "explanation": "–û—Ç–µ—Ü –∏–∑–±–∏—Ä–∞–µ—Ç, –î—É—Ö –æ—Å–≤—è—â–∞–µ—Ç, –°—ã–Ω –∏—Å–∫—É–ø–∞–µ—Ç."
    },
    {
        "question": "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –≥—Ä–µ—á–µ—Å–∫–æ–µ 'œÄŒ±œÅŒ±Œ∫œçœàŒ±Œπ' –≤ 1 –ü–µ—Ç. 1:12?",
        "options": ["–°—Ç—Ä–∞—Ö –∏ —Ç—Ä–µ–ø–µ—Ç", "–ë–ª–∞–≥–æ–≥–æ–≤–µ–π–Ω–æ–µ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ", "–ì–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "–ù–µ–¥–æ—É–º–µ–Ω–∏–µ"],
        "correct": 1,
        "explanation": "–û–∑–Ω–∞—á–∞–µ—Ç '–Ω–∞–∫–ª–æ–Ω–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –∑–∞–≥–ª—è–Ω—É—Ç—å'."
    },
    {
        "question": "–ü–æ—á–µ–º—É –ü–µ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –æ–±—Ä–∞–∑ '–ø—Ä–µ–ø–æ—è—Å–∞–Ω–∏—è —á—Ä–µ—Å–µ–ª'?",
        "options": ["–û–¥–µ–∂–¥–∞ —Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", "–í–æ–∏–Ω—Å–∫–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å", "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ò—Å—Ö–æ–¥—É", "–°–∏–º–≤–æ–ª —Å–∫—Ä–æ–º–Ω–æ—Å—Ç–∏"],
        "correct": 2,
        "explanation": "–û–±—Ä–∞–∑ –æ—Ç—Å—ã–ª–∞–µ—Ç –∫ –ò—Å—Ö–æ–¥—É (–ò—Å—Ö. 12:11)."
    },
    {
        "question": "–ß—Ç–æ –ü–µ—Ç—Ä –ù–ï —É–ø–æ–º—è–Ω—É–ª –∫–∞–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –Ω–∞—Å–ª–µ–¥–∏—è?",
        "options": ["–ù–µ—Ç–ª–µ–Ω–Ω–æ–µ", "–ß–∏—Å—Ç–æ–µ", "–ù–µ—É–≤—è–¥–∞–µ–º–æ–µ", "–ë–µ–∑–≥—Ä–µ—à–Ω–æ–µ"],
        "correct": 3,
        "explanation": "'–ë–µ–∑–≥—Ä–µ—à–Ω–æ–µ' –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –æ–ø–∏—Å–∞–Ω–∏–∏."
    },
    {
        "question": "–ö–∞–∫–æ–π –æ–±—Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏—Å–ø—ã—Ç–∞–Ω–∏–π –≤–µ—Ä—ã?",
        "options": ["–ó–æ–ª–æ—Ç–æ –≤ –æ–≥–Ω–µ", "–¢–µ—Ä–ø–µ–Ω–∏–µ —Ä–æ–∂–¥–∞–µ—Ç –æ–ø—ã—Ç–Ω–æ—Å—Ç—å", "–°—Ç—Ä–∞–¥–∞–Ω–∏–µ –æ—á–∏—â–∞–µ—Ç", "–í–µ—Ä–∞ –±–µ–∑ –¥–µ–ª –º–µ—Ä—Ç–≤–∞"],
        "correct": 0,
        "explanation": "–û–±—Ä–∞–∑ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –∑–æ–ª–æ—Ç–∞ –æ–≥–Ω—ë–º (1 –ü–µ—Ç. 1:7)."
    },
    {
        "question": "–í –∫–∞–∫–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ü–µ—Ç—Ä –≥–æ–≤–æ—Ä–∏—Ç –æ '–∂–∏–≤–æ–π –Ω–∞–¥–µ–∂–¥–µ'?",
        "options": ["–£–ª—É—á—à–µ–Ω–∏–µ –∂–∏–∑–Ω–∏", "–í–æ—Å–∫—Ä–µ—Å—à–∏–π –•—Ä–∏—Å—Ç–æ—Å", "–ò–∑–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç —Å—Ç—Ä–∞–¥–∞–Ω–∏–π", "–í—Ç–æ—Ä–æ–µ –ø—Ä–∏—à–µ—Å—Ç–≤–∏–µ"],
        "correct": 1,
        "explanation": "'–ñ–∏–≤–∞—è –Ω–∞–¥–µ–∂–¥–∞' –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω–∏–∏."
    },
    {
        "question": "–ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã —Å—Ç—Ä–∞–¥–∞–Ω–∏—è –•—Ä–∏—Å—Ç–∞ –∏ –ï–≥–æ —Å–ª–∞–≤–∞?",
        "options": ["–°–ª–∞–≤–∞ –±–µ–∑ —Å—Ç—Ä–∞–¥–∞–Ω–∏–π", "–°—Ç—Ä–∞–¥–∞–Ω–∏—è –±–µ–∑ —Å–ª–∞–≤—ã", "–°–Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è, –ø–æ—Ç–æ–º —Å–ª–∞–≤–∞", "–°–ª–∞–≤–∞ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç—Ä–∞–¥–∞–Ω–∏—è"],
        "correct": 2,
        "explanation": "–°–Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è, –∑–∞—Ç–µ–º –ø—Ä–æ—Å–ª–∞–≤–ª–µ–Ω–∏–µ."
    },
    {
        "question": "–ö–∞–∫–∞—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è –≤–µ—Ä—É—é—â–∏—Ö –≤ 1 –ü–µ—Ç. 1:12?",
        "options": ["–£–º–Ω–µ–µ –ø—Ä–æ—Ä–æ–∫–æ–≤", "–ñ–∏–≤—É—Ç –≤ —ç–ø–æ—Ö—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è", "–ù–µ –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞—Ö", "–ó–Ω–∞—é—Ç –±–æ–ª—å—à–µ –∞–Ω–≥–µ–ª–æ–≤"],
        "correct": 1,
        "explanation": "–í–µ—Ä—É—é—â–∏–µ –∂–∏–≤—É—Ç –≤ —ç–ø–æ—Ö—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤."
    },
    {
        "question": "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç '–Ω–µ —Å–æ–æ–±—Ä–∞–∑—É–π—Ç–µ—Å—å —Å –ø—Ä–µ–∂–Ω–∏–º–∏ –ø–æ—Ö–æ—Ç—è–º–∏'?",
        "options": ["–ü–æ–ª–Ω–æ–µ –±–µ–∑–≥—Ä–µ—à–∏–µ", "–û—Ç–¥–µ–ª–µ–Ω–∏–µ –æ—Ç –≥—Ä–µ—Ö–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—à–ª–æ–≥–æ", "–ê—Å–∫–µ—Ç–∏–∑–º", "–£—Ö–æ–¥ –æ—Ç –º–∏—Ä–∞"],
        "correct": 1,
        "explanation": "–ü—Ä–∏–∑—ã–≤ –æ—Ç–¥–µ–ª–∏—Ç—å—Å—è –æ—Ç –≥—Ä–µ—Ö–æ–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–æ—à–ª–æ–≥–æ."
    },
    {
        "question": "–ü–æ—á–µ–º—É –ë–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç '—Å–∏–ª–æ—é –ë–æ–∂–∏–µ–π —á–µ—Ä–µ–∑ –≤–µ—Ä—É'?",
        "options": ["–í–µ—Ä–∞ ‚Äî –Ω–∞—à–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ", "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –¥–∞—Ä –ë–æ–∂–∏–π", "–ë–æ–≥ –ø–æ–º–æ–≥–∞–µ—Ç —Å–∏–ª—å–Ω—ã–º", "–í–µ—Ä–∞ –∑–∞–º–µ–Ω—è–µ—Ç —Å–∏–ª—É"],
        "correct": 1,
        "explanation": "–ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã —Å–∏–ª–æ—é –ë–æ–∂–∏–µ–π, –Ω–µ –Ω–∞—à–µ–π."
    },
    {
        "question": "–ö–∞–∫–æ–π —Ñ–∞–∫—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä–∞–Ω–Ω—é—é –¥–∞—Ç–∏—Ä–æ–≤–∫—É?",
        "options": ["–†–∞–∑—Ä—É—à–µ–Ω–∏–µ –ò–µ—Ä—É—Å–∞–ª–∏–º–∞", "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≥–æ–Ω–µ–Ω–∏–π –ù–µ—Ä–æ–Ω–∞", "–°–º–µ—Ä—Ç—å –ü–∞–≤–ª–∞", "–ü—Ä–∞–≤–ª–µ–Ω–∏–µ –î–æ–º–∏—Ü–∏–∞–Ω–∞"],
        "correct": 1,
        "explanation": "–ì–æ–Ω–µ–Ω–∏—è –ù–µ—Ä–æ–Ω–∞ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å."
    },
    {
        "question": "–ö–∞–∫–æ–π –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ü–µ—Ç—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã –≤–µ—Ä—É—é—â–∏—Ö?",
        "options": ["–ü—Ä—è–º—ã–µ –∏–º–µ–Ω–∞", "–ê–ª–ª–µ–≥–æ—Ä–∏–∏ –∏ —Å–∏–º–≤–æ–ª—ã", "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã", "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–∑—É–Ω–≥–∏"],
        "correct": 1,
        "explanation": "–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è."
    },
    {
        "question": "–ü–æ—á–µ–º—É –†–∏–º –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–ª—Å—è —Å –í–∞–≤–∏–ª–æ–Ω–æ–º?",
        "options": ["–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞", "–ò–¥–æ–ª–æ–ø–æ–∫–ª–æ–Ω—Å—Ç–≤–æ –∏ –≤–ª–∞—Å—Ç—å", "–Ø–∑—ã–∫", "–¢–æ—Ä–≥–æ–≤–ª—è"],
        "correct": 1,
        "explanation": "–í–∞–≤–∏–ª–æ–Ω ‚Äî —Å–∏–º–≤–æ–ª —è–∑—ã—á–µ—Å–∫–æ–π –≤–ª–∞—Å—Ç–∏."
    },
    {
        "question": "–ö–∞–∫–æ–π —Ä–∏—Å–∫ –Ω–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ö—Ä–∏—Å—Ç–∏–∞–Ω?",
        "options": ["–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π", "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π", "–§–∏–∑–∏—á–µ—Å–∫–∏–µ –≥–æ–Ω–µ–Ω–∏—è", "–°–æ—Ü–∏–∞–ª—å–Ω—ã–π"],
        "correct": 2,
        "explanation": "–•—Ä–∏—Å—Ç–∏–∞–Ω–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –∫–∞–∑–Ω–µ–Ω—ã."
    },
    {
        "question": "–ö–∞–∫ –ü–µ—Ç—Ä —Å–æ—á–µ—Ç–∞–µ—Ç –±–æ–≥–æ—Å–ª–æ–≤–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—é?",
        "options": ["–û—Ç–¥–µ–ª—è–µ—Ç –∏—Ö", "–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é", "–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç", "–ü—Ä–æ—Ç–∏–≤–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç"],
        "correct": 2,
        "explanation": "–ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è –≤–µ—Ä—ã."
    }
]

# ==========================================
# üëë –ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï–†–û–ù–ê (15 –≤–æ–ø—Ä–æ—Å–æ–≤)
# ==========================================
nero_questions = [
    {
        "question": "–í –∫–∞–∫–æ–º –≥–æ–¥—É –ù–µ—Ä–æ–Ω —Å—Ç–∞–ª –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–º?",
        "options": ["41 –≥. –Ω.—ç.", "54 –≥. –Ω.—ç.", "64 –≥. –Ω.—ç.", "68 –≥. –Ω.—ç."],
        "correct": 1,
        "explanation": "–ù–µ—Ä–æ–Ω —Å—Ç–∞–ª –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤ 54 –≥–æ–¥—É –≤ –≤–æ–∑—Ä–∞—Å—Ç–µ 16 –ª–µ—Ç."
    },
    {
        "question": "–ö–∞–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å—Ç–∞–ª–æ –ø–æ–≤–æ–¥–æ–º –¥–ª—è –≥–æ–Ω–µ–Ω–∏–π –Ω–∞ —Ö—Ä–∏—Å—Ç–∏–∞–Ω?",
        "options": ["–í–æ—Å—Å—Ç–∞–Ω–∏–µ –∏—É–¥–µ–µ–≤", "–ü–æ–∂–∞—Ä –†–∏–º–∞ –≤ 64 –≥.", "–ó–∞–≥–æ–≤–æ—Ä —Å–µ–Ω–∞—Ç–∞", "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫—Ä–∏–∑–∏—Å"],
        "correct": 1,
        "explanation": "–ü–æ—Å–ª–µ –ø–æ–∂–∞—Ä–∞ –†–∏–º–∞ –ù–µ—Ä–æ–Ω –æ–±–≤–∏–Ω–∏–ª —Ö—Ä–∏—Å—Ç–∏–∞–Ω."
    },
    {
        "question": "–ö–∞–∫ –∑–≤–∞–ª–∏ –º–∞—Ç—å –ù–µ—Ä–æ–Ω–∞?",
        "options": ["–õ–∏–≤–∏—è", "–ê–≥—Ä–∏–ø–ø–∏–Ω–∞", "–ú–µ—Å—Å–∞–ª–∏–Ω–∞", "–û–∫—Ç–∞–≤–∏—è"],
        "correct": 1,
        "explanation": "–ú–∞—Ç—å –ù–µ—Ä–æ–Ω–∞ ‚Äî –ê–≥—Ä–∏–ø–ø–∏–Ω–∞ –ú–ª–∞–¥—à–∞—è."
    },
    {
        "question": "–ö–∞–∫–æ–π –∞–ø–æ—Å—Ç–æ–ª –±—ã–ª —Ä–∞—Å–ø—è—Ç –≤ –†–∏–º–µ –ø—Ä–∏ –ù–µ—Ä–æ–Ω–µ?",
        "options": ["–ü–∞–≤–µ–ª", "–ü–µ—Ç—Ä", "–ò–æ–∞–Ω–Ω", "–ò–∞–∫–æ–≤"],
        "correct": 1,
        "explanation": "–ê–ø–æ—Å—Ç–æ–ª –ü–µ—Ç—Ä –±—ã–ª —Ä–∞—Å–ø—è—Ç –≤–Ω–∏–∑ –≥–æ–ª–æ–≤–æ–π."
    },
    {
        "question": "–ö–∞–∫–æ–π –∞–ø–æ—Å—Ç–æ–ª –±—ã–ª –æ–±–µ–∑–≥–ª–∞–≤–ª–µ–Ω –ø—Ä–∏ –ù–µ—Ä–æ–Ω–µ?",
        "options": ["–ü–µ—Ç—Ä", "–ü–∞–≤–µ–ª", "–ê–Ω–¥—Ä–µ–π", "–§–æ–º–∞"],
        "correct": 1,
        "explanation": "–ê–ø–æ—Å—Ç–æ–ª –ü–∞–≤–µ–ª –∫–∞–∫ —Ä–∏–º—Å–∫–∏–π –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω –±—ã–ª –æ–±–µ–∑–≥–ª–∞–≤–ª–µ–Ω."
    },
    {
        "question": "–í –∫–∞–∫–æ–º –≥–æ–¥—É —É–º–µ—Ä –ù–µ—Ä–æ–Ω?",
        "options": ["64 –≥. –Ω.—ç.", "66 –≥. –Ω.—ç.", "68 –≥. –Ω.—ç.", "70 –≥. –Ω.—ç."],
        "correct": 2,
        "explanation": "–ù–µ—Ä–æ–Ω –ø–æ–∫–æ–Ω—á–∏–ª —Å —Å–æ–±–æ–π –≤ 68 –≥–æ–¥—É."
    },
    {
        "question": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–ª—Å—è –¥–≤–æ—Ä–µ—Ü –ù–µ—Ä–æ–Ω–∞?",
        "options": ["–ö–æ–ª–∏–∑–µ–π", "–ó–æ–ª–æ—Ç–æ–π –¥–æ–º", "–ü–∞–Ω—Ç–µ–æ–Ω", "–§–æ—Ä—É–º –ù–µ—Ä–æ–Ω–∞"],
        "correct": 1,
        "explanation": "–ü–æ—Å–ª–µ –ø–æ–∂–∞—Ä–∞ –ù–µ—Ä–æ–Ω –ø–æ—Å—Ç—Ä–æ–∏–ª –ó–æ–ª–æ—Ç–æ–π –¥–æ–º (Domus Aurea)."
    },
    {
        "question": "–ö–∞–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –ª—é–±–∏–ª –ù–µ—Ä–æ–Ω?",
        "options": ["–°–∫—É–ª—å–ø—Ç—É—Ä–∞", "–ú—É–∑—ã–∫–∞ –∏ —Ç–µ–∞—Ç—Ä", "–ñ–∏–≤–æ–ø–∏—Å—å", "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞"],
        "correct": 1,
        "explanation": "–ù–µ—Ä–æ–Ω —Å—á–∏—Ç–∞–ª —Å–µ–±—è –≤–µ–ª–∏–∫–∏–º –ø–µ–≤—Ü–æ–º –∏ –∞–∫—Ç—ë—Ä–æ–º."
    },
    {
        "question": "–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≥–æ—Ä–µ–ª –†–∏–º?",
        "options": ["3 –¥–Ω—è", "6 –¥–Ω–µ–π", "9 –¥–Ω–µ–π", "12 –¥–Ω–µ–π"],
        "correct": 1,
        "explanation": "–í–µ–ª–∏–∫–∏–π –ø–æ–∂–∞—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è –æ–∫–æ–ª–æ 6 –¥–Ω–µ–π."
    },
    {
        "question": "–ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –†–∏–º–∞ –±—ã–ª —É–Ω–∏—á—Ç–æ–∂–µ–Ω?",
        "options": ["–û–∫–æ–ª–æ 30%", "–û–∫–æ–ª–æ 50%", "–û–∫–æ–ª–æ 70%", "–û–∫–æ–ª–æ 90%"],
        "correct": 2,
        "explanation": "–ü–æ–∂–∞—Ä —É–Ω–∏—á—Ç–æ–∂–∏–ª –æ–∫–æ–ª–æ 70% –≥–æ—Ä–æ–¥–∞."
    },
    {
        "question": "–ö–∞–∫ –∫–∞–∑–Ω–∏–ª–∏ —Ö—Ä–∏—Å—Ç–∏–∞–Ω –ø—Ä–∏ –ù–µ—Ä–æ–Ω–µ?",
        "options": ["–¢–æ–ª—å–∫–æ –æ–±–µ–∑–≥–ª–∞–≤–ª–∏–≤–∞–Ω–∏–µ", "–†–∞—Å–ø—è—Ç–∏–µ, —Å–æ–∂–∂–µ–Ω–∏–µ, –∑–≤–µ—Ä–∏", "–¢–æ–ª—å–∫–æ –∏–∑–≥–Ω–∞–Ω–∏–µ", "–¢–æ–ª—å–∫–æ —Ç—é—Ä—å–º–∞"],
        "correct": 1,
        "explanation": "–•—Ä–∏—Å—Ç–∏–∞–Ω —Ä–∞—Å–ø–∏–Ω–∞–ª–∏, —Å–∂–∏–≥–∞–ª–∏, –±—Ä–æ—Å–∞–ª–∏ –∑–≤–µ—Ä—è–º."
    },
    {
        "question": "–ö—Ç–æ –±—ã–ª –≤–æ—Å–ø–∏—Ç–∞—Ç–µ–ª–µ–º –ù–µ—Ä–æ–Ω–∞?",
        "options": ["–¶–∏—Ü–µ—Ä–æ–Ω", "–°–µ–Ω–µ–∫–∞", "–ü–ª–∏–Ω–∏–π", "–¢–∞—Ü–∏—Ç"],
        "correct": 1,
        "explanation": "–§–∏–ª–æ—Å–æ—Ñ –°–µ–Ω–µ–∫–∞ –±—ã–ª –≤–æ—Å–ø–∏—Ç–∞—Ç–µ–ª–µ–º –ù–µ—Ä–æ–Ω–∞."
    },
    {
        "question": "–ö–∞–∫–æ–≤–∞ –±—ã–ª–∞ —Å—É–¥—å–±–∞ –°–µ–Ω–µ–∫–∏?",
        "options": ["–£–º–µ—Ä —Å–≤–æ–µ–π —Å–º–µ—Ä—Ç—å—é", "–í—ã–Ω—É–∂–¥–µ–Ω –ø–æ–∫–æ–Ω—á–∏—Ç—å —Å —Å–æ–±–æ–π", "–ë–µ–∂–∞–ª –∏–∑ –†–∏–º–∞", "–°—Ç–∞–ª –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–º"],
        "correct": 1,
        "explanation": "–°–µ–Ω–µ–∫–∞ –±—ã–ª –æ–±–≤–∏–Ω—ë–Ω –≤ –∑–∞–≥–æ–≤–æ—Ä–µ –∏ –≤—ã–Ω—É–∂–¥–µ–Ω —Å–æ–≤–µ—Ä—à–∏—Ç—å —Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ."
    },
    {
        "question": "–ß—Ç–æ –∫—Ä–∏—á–∞–ª –ù–µ—Ä–æ–Ω –ø–µ—Ä–µ–¥ —Å–º–µ—Ä—Ç—å—é?",
        "options": ["–î–∞ –∑–¥—Ä–∞–≤—Å—Ç–≤—É–µ—Ç –†–∏–º!", "–ö–∞–∫–æ–π –∞—Ä—Ç–∏—Å—Ç –ø–æ–≥–∏–±–∞–µ—Ç!", "–Ø –Ω–µ–≤–∏–Ω–æ–≤–µ–Ω!", "–ë–æ–≥–∏, –ø—Ä–æ—Å—Ç–∏—Ç–µ!"],
        "correct": 1,
        "explanation": "–ü–æ –ø—Ä–µ–¥–∞–Ω–∏—é: ¬´–ö–∞–∫–æ–π –≤–µ–ª–∏–∫–∏–π –∞—Ä—Ç–∏—Å—Ç –ø–æ–≥–∏–±–∞–µ—Ç!¬ª"
    },
    {
        "question": "–ü–æ—á–µ–º—É –≥–æ–Ω–µ–Ω–∏—è –≤–∞–∂–Ω—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è 1 –ü–µ—Ç—Ä–∞?",
        "options": ["–ü–∏—Å—å–º–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Ö", "–ü–∏—Å—å–º–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∞–∫–∞–Ω—É–Ω–µ", "–ü–∏—Å—å–º–æ –ø–æ—Å–ª–µ –≥–æ–Ω–µ–Ω–∏–π", "–ù–µ —Å–≤—è–∑–∞–Ω—ã"],
        "correct": 1,
        "explanation": "–ü–æ—Å–ª–∞–Ω–∏–µ –Ω–∞–ø–∏—Å–∞–Ω–æ –æ–∫–æ–ª–æ 62-63 –≥–≥., –¥–æ –Ω–∞—á–∞–ª–∞ –≥–æ–Ω–µ–Ω–∏–π –≤ 64 –≥."
    }
]

# ==========================================
# üåç –ì–ï–û–ì–†–ê–§–ò–Ø –ó–ï–ú–õ–ò (10 –≤–æ–ø—Ä–æ—Å–æ–≤)
# ==========================================
geography_questions = [
    {
        "question": "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –ú–∞–ª–∞—è –ê–∑–∏—è?",
        "options": ["–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¢—É—Ä—Ü–∏—è", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ò—Ç–∞–ª–∏—è", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ï–≥–∏–ø–µ—Ç", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ì—Ä–µ—Ü–∏—è"],
        "correct": 0,
        "explanation": "–ú–∞–ª–∞—è –ê–∑–∏—è ‚Äî —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –¢—É—Ä—Ü–∏–∏."
    },
    {
        "question": "–ö–∞–∫–∞—è –∏–º–ø–µ—Ä–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞–ª–∞ –ú–∞–ª—É—é –ê–∑–∏—é –≤ I –≤–µ–∫–µ?",
        "options": ["–ü–µ—Ä—Å–∏–¥—Å–∫–∞—è", "–ì—Ä–µ—á–µ—Å–∫–∞—è", "–†–∏–º—Å–∫–∞—è", "–í–∞–≤–∏–ª–æ–Ω—Å–∫–∞—è"],
        "correct": 2,
        "explanation": "–ú–∞–ª–∞—è –ê–∑–∏—è –±—ã–ª–∞ —á–∞—Å—Ç—å—é –†–∏–º—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏."
    },
    {
        "question": "–ö–∞–∫–∏–µ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –≤ 1 –ü–µ—Ç—Ä–∞ 1:1?",
        "options": ["–ò—É–¥–µ—è, –°–∞–º–∞—Ä–∏—è, –ì–∞–ª–∏–ª–µ—è", "–ü–æ–Ω—Ç, –ì–∞–ª–∞—Ç–∏—è, –ö–∞–ø–ø–∞–¥–æ–∫–∏—è, –ê—Å–∏—è, –í–∏—Ñ–∏–Ω–∏—è", "–ï–≥–∏–ø–µ—Ç, –°–∏—Ä–∏—è, –ê—Ä–∞–≤–∏—è", "–ú–∞–∫–µ–¥–æ–Ω–∏—è, –ê—Ö–∞–∏—è, –§—Ä–∞–∫–∏—è"],
        "correct": 1,
        "explanation": "–ü—ë—Ç—Ä –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ö—Ä–∏—Å—Ç–∏–∞–Ω–∞–º –≤ —ç—Ç–∏—Ö –ø—Ä–æ–≤–∏–Ω—Ü–∏—è—Ö."
    },
    {
        "question": "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –±—ã–ª —Å—Ç–æ–ª–∏—Ü–µ–π –†–∏–º—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏?",
        "options": ["–ê—Ñ–∏–Ω—ã", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—è", "–†–∏–º", "–ê–Ω—Ç–∏–æ—Ö–∏—è"],
        "correct": 2,
        "explanation": "–†–∏–º –±—ã–ª —Å—Ç–æ–ª–∏—Ü–µ–π –∏–º–ø–µ—Ä–∏–∏."
    },
    {
        "question": "–ö–∞–∫–æ–µ –º–æ—Ä–µ –æ–º—ã–≤–∞–ª–æ –ú–∞–ª—É—é –ê–∑–∏—é?",
        "options": ["–ö—Ä–∞—Å–Ω–æ–µ –º–æ—Ä–µ", "–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–µ –º–æ—Ä–µ", "–ö–∞—Å–ø–∏–π—Å–∫–æ–µ –º–æ—Ä–µ", "–ë–∞–ª—Ç–∏–π—Å–∫–æ–µ –º–æ—Ä–µ"],
        "correct": 1,
        "explanation": "–ú–∞–ª–∞—è –ê–∑–∏—è –æ–º—ã–≤–∞–µ—Ç—Å—è –°—Ä–µ–¥–∏–∑–µ–º–Ω—ã–º, –≠–≥–µ–π—Å–∫–∏–º –∏ –ß—ë—Ä–Ω—ã–º –º–æ—Ä—è–º–∏."
    },
    {
        "question": "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –±—ã–ª —Ü–µ–Ω—Ç—Ä–æ–º –∏—É–¥–∞–∏–∑–º–∞?",
        "options": ["–†–∏–º", "–ê–Ω—Ç–∏–æ—Ö–∏—è", "–ò–µ—Ä—É—Å–∞–ª–∏–º", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—è"],
        "correct": 2,
        "explanation": "–ò–µ—Ä—É—Å–∞–ª–∏–º –±—ã–ª –¥—É—Ö–æ–≤–Ω—ã–º —Ü–µ–Ω—Ç—Ä–æ–º –∏—É–¥–∞–∏–∑–º–∞."
    },
    {
        "question": "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç '–¥–∏–∞—Å–ø–æ—Ä–∞'?",
        "options": ["–ü–∞–ª–æ–º–Ω–∏—á–µ—Å—Ç–≤–æ", "–†–∞—Å—Å–µ—è–Ω–Ω—ã–µ –æ–±—â–∏–Ω—ã –≤–Ω–µ —Ä–æ–¥–∏–Ω—ã", "–í–æ–µ–Ω–Ω—ã–π –ø–æ—Ö–æ–¥", "–¢–æ—Ä–≥–æ–≤—ã–π —Å–æ—é–∑"],
        "correct": 1,
        "explanation": "–î–∏–∞—Å–ø–æ—Ä–∞ ‚Äî —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–µ –æ–±—â–∏–Ω—ã –≤–Ω–µ —Ä–æ–¥–∏–Ω—ã."
    },
    {
        "question": "–ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å –í–∞–≤–∏–ª–æ–Ω–æ–º –≤ –ù–ó?",
        "options": ["–ò–µ—Ä—É—Å–∞–ª–∏–º", "–†–∏–º", "–ê—Ñ–∏–Ω—ã", "–ö–æ—Ä–∏–Ω—Ñ"],
        "correct": 1,
        "explanation": "–†–∏–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏ –Ω–∞–∑—ã–≤–∞–ª—Å—è –í–∞–≤–∏–ª–æ–Ω–æ–º."
    },
    {
        "question": "–ö–∞–∫–æ–π –ø—É—Ç—å –ø—Ä–æ—Ö–æ–¥–∏–ª —á–µ—Ä–µ–∑ –ú–∞–ª—É—é –ê–∑–∏—é?",
        "options": ["–Ø–Ω—Ç–∞—Ä–Ω—ã–π –ø—É—Ç—å", "–®—ë–ª–∫–æ–≤—ã–π –ø—É—Ç—å", "–ü—É—Ç—å –±–ª–∞–≥–æ–≤–æ–Ω–∏–π", "–°–æ–ª—è–Ω–æ–π –ø—É—Ç—å"],
        "correct": 1,
        "explanation": "–ß–µ—Ä–µ–∑ –ú–∞–ª—É—é –ê–∑–∏—é –ø—Ä–æ—Ö–æ–¥–∏–ª –®—ë–ª–∫–æ–≤—ã–π –ø—É—Ç—å."
    },
    {
        "question": "–ì–¥–µ –≤–µ—Ä—É—é—â–∏–µ –≤–ø–µ—Ä–≤—ã–µ –Ω–∞–∑–≤–∞–Ω—ã —Ö—Ä–∏—Å—Ç–∏–∞–Ω–∞–º–∏?",
        "options": ["–ò–µ—Ä—É—Å–∞–ª–∏–º", "–†–∏–º", "–ê–Ω—Ç–∏–æ—Ö–∏—è", "–ï—Ñ–µ—Å"],
        "correct": 2,
        "explanation": "–£—á–µ–Ω–∏–∫–∏ –≤–ø–µ—Ä–≤—ã–µ –Ω–∞–∑–≤–∞–Ω—ã —Ö—Ä–∏—Å—Ç–∏–∞–Ω–∞–º–∏ –≤ –ê–Ω—Ç–∏–æ—Ö–∏–∏ (–î–µ—è–Ω. 11:26)."
    }
]

# ==========================================
# ‚öîÔ∏è –í–û–ü–†–û–°–´ –î–õ–Ø –ë–ò–¢–í (—Å–º–µ—à–∞–Ω–Ω—ã–µ)
# ==========================================
battle_questions = easy_questions + medium_questions + hard_questions

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
user_data = {}
pending_battles = {}  # –û–∂–∏–¥–∞—é—â–∏–µ –±–∏—Ç–≤—ã

# --- –§–£–ù–ö–¶–ò–ò –ë–ê–ó–´ –î–ê–ù–ù–´–• ---

def get_user_stats(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if collection is None:
        return None
    
    user_id_str = str(user_id)
    entry = collection.find_one({"_id": user_id_str})
    
    if not entry:
        return None
    return entry

def init_user_stats(user_id, username, first_name):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if collection is None:
        return
    
    user_id_str = str(user_id)
    entry = collection.find_one({"_id": user_id_str})
    
    if not entry:
        new_entry = {
            "_id": user_id_str,
            "username": username or "–ë–µ–∑ username",
            "first_name": first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            "first_play_date": datetime.now().strftime("%Y-%m-%d"),
            "total_points": 0,
            "total_tests": 0,
            "total_questions_answered": 0,
            "total_correct_answers": 0,
            "total_time_spent": 0,
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º
            "easy_attempts": 0, "easy_correct": 0, "easy_total": 0, "easy_best_score": 0,
            "medium_attempts": 0, "medium_correct": 0, "medium_total": 0, "medium_best_score": 0,
            "hard_attempts": 0, "hard_correct": 0, "hard_total": 0, "hard_best_score": 0,
            "nero_attempts": 0, "nero_correct": 0, "nero_total": 0, "nero_best_score": 0,
            "geography_attempts": 0, "geography_correct": 0, "geography_total": 0, "geography_best_score": 0,
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏—Ç–≤
            "battles_played": 0,
            "battles_won": 0,
            "battles_lost": 0,
            "battles_draw": 0,
            "last_date": datetime.now().strftime("%Y-%m-%d %H:%M")
        }
        collection.insert_one(new_entry)

def add_to_leaderboard(user_id, username, first_name, level_key, score, total, time_seconds):
    if collection is None:
        return

    points_per_question = {"easy": 1, "medium": 2, "hard": 3, "nero": 2, "geography": 2}
    earned_points = score * points_per_question.get(level_key, 1)
    user_id_str = str(user_id)
    
    try:
        entry = collection.find_one({"_id": user_id_str})
        
        if entry:
            update_data = {
                "total_points": entry.get("total_points", 0) + earned_points,
                "total_tests": entry.get("total_tests", 0) + 1,
                "total_questions_answered": entry.get("total_questions_answered", 0) + total,
                "total_correct_answers": entry.get("total_correct_answers", 0) + score,
                "total_time_spent": entry.get("total_time_spent", 0) + time_seconds,
                f"{level_key}_attempts": entry.get(f"{level_key}_attempts", 0) + 1,
                f"{level_key}_correct": entry.get(f"{level_key}_correct", 0) + score,
                f"{level_key}_total": entry.get(f"{level_key}_total", 0) + total,
                f"{level_key}_best_score": max(entry.get(f"{level_key}_best_score", 0), score),
                "last_date": datetime.now().strftime("%Y-%m-%d %H:%M"),
                "first_name": first_name,
                "username": username
            }
            collection.update_one({"_id": user_id_str}, {"$set": update_data})
        else:
            init_user_stats(user_id, username, first_name)
            # –ü–æ–≤—Ç–æ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            add_to_leaderboard(user_id, username, first_name, level_key, score, total, time_seconds)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: {e}")

def update_battle_stats(user_id, result):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∏—Ç–≤: result = 'win', 'lose', 'draw'"""
    if collection is None:
        return
    
    user_id_str = str(user_id)
    entry = collection.find_one({"_id": user_id_str})
    
    if entry:
        update_data = {
            "battles_played": entry.get("battles_played", 0) + 1,
        }
        if result == "win":
            update_data["battles_won"] = entry.get("battles_won", 0) + 1
            update_data["total_points"] = entry.get("total_points", 0) + 5  # –ë–æ–Ω—É—Å –∑–∞ –ø–æ–±–µ–¥—É
        elif result == "lose":
            update_data["battles_lost"] = entry.get("battles_lost", 0) + 1
        else:
            update_data["battles_draw"] = entry.get("battles_draw", 0) + 1
            update_data["total_points"] = entry.get("total_points", 0) + 2  # –ë–æ–Ω—É—Å –∑–∞ –Ω–∏—á—å—é
        
        collection.update_one({"_id": user_id_str}, {"$set": update_data})

def get_user_position(user_id):
    if collection is None:
        return None, None
    user_id_str = str(user_id)
    try:
        entry = collection.find_one({"_id": user_id_str})
        if not entry:
            return None, None
        my_points = entry.get("total_points", 0)
        count_better = collection.count_documents({"total_points": {"$gt": my_points}})
        return count_better + 1, entry
    except Exception:
        return None, None

def get_leaderboard_page(page_number):
    if collection is None:
        return []
    try:
        skip_amount = page_number * 10
        return list(collection.find().sort("total_points", -1).skip(skip_amount).limit(10))
    except Exception:
        return []

def get_total_users():
    if collection is None:
        return 0
    try:
        return collection.count_documents({})
    except Exception:
        return 0

def format_time(seconds):
    if seconds == float('inf') or seconds == 0:
        return "‚Äî"
    minutes = int(seconds // 60)
    secs = int(seconds % 60)
    if minutes > 0:
        return f"{minutes}–º {secs}—Å"
    return f"{secs}—Å"

def calculate_days_playing(first_play_date):
    """–í—ã—á–∏—Å–ª–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –∏–≥—Ä–∞–µ—Ç"""
    try:
        first_date = datetime.strptime(first_play_date, "%Y-%m-%d")
        delta = datetime.now() - first_date
        return delta.days + 1
    except:
        return 1

def calculate_accuracy(correct, total):
    """–í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"""
    if total == 0:
        return 0
    return round((correct / total) * 100)

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context):
    user = update.effective_user
    init_user_stats(user.id, user.username, user.first_name)
    
    keyboard = [
        [InlineKeyboardButton("üìñ –û –±–æ—Ç–µ", callback_data='about')],
        [InlineKeyboardButton("üéØ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data='start_test')],
        [InlineKeyboardButton("‚öîÔ∏è –†–µ–∂–∏–º –±–∏—Ç–≤—ã", callback_data='battle_menu')],
        [InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data='leaderboard')],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='my_stats')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        'üìñ *–ë–ò–ë–õ–ï–ô–°–ö–ò–ô –¢–ï–°–¢-–ë–û–¢*\n\n'
        '*–¢–µ–º–∞:* 1 –ü–µ—Ç—Ä–∞ 1:1-16\n\n'
        'üìö *5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–µ—Å—Ç–æ–≤:*\n'
        'üü¢ –õ—ë–≥–∫–∏–π ‚Ä¢ üü° –°—Ä–µ–¥–Ω–∏–π ‚Ä¢ üî¥ –°–ª–æ–∂–Ω—ã–π\n'
        'üëë –ü—Ä–∞–≤–ª–µ–Ω–∏–µ –ù–µ—Ä–æ–Ω–∞ ‚Ä¢ üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è\n\n'
        '‚öîÔ∏è *–ù–æ–≤—ã–π —Ä–µ–∂–∏–º:* –ë–∏—Ç–≤–∞ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏!\n\n'
        '–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:',
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
async def button_handler(update: Update, context):
    query = update.callback_query
    await query.answer()
    
    if query.data.startswith('leaderboard_page_'):
        page = int(query.data.split('_')[2])
        await show_general_leaderboard(query, page)
        return

    if query.data == 'about':
        await query.edit_message_text(
            'üìö *–û –ë–û–¢–ï*\n\n'
            '–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞–Ω–∏—è –ø–æ –ü–µ—Ä–≤–æ–º—É –ø–æ—Å–ª–∞–Ω–∏—é –ü–µ—Ç—Ä–∞.\n\n'
            '*üìã –ö–ê–¢–ï–ì–û–†–ò–ò –¢–ï–°–¢–û–í:*\n'
            'üü¢ –õ—ë–≥–∫–∏–π ‚Äî 1 –±–∞–ª–ª (15 –≤–æ–ø—Ä–æ—Å–æ–≤)\n'
            'üü° –°—Ä–µ–¥–Ω–∏–π ‚Äî 2 –±–∞–ª–ª–∞ (15 –≤–æ–ø—Ä–æ—Å–æ–≤)\n'
            'üî¥ –°–ª–æ–∂–Ω—ã–π ‚Äî 3 –±–∞–ª–ª–∞ (15 –≤–æ–ø—Ä–æ—Å–æ–≤)\n'
            'üëë –ù–µ—Ä–æ–Ω ‚Äî 2 –±–∞–ª–ª–∞ (15 –≤–æ–ø—Ä–æ—Å–æ–≤)\n'
            'üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è ‚Äî 2 –±–∞–ª–ª–∞ (10 –≤–æ–ø—Ä–æ—Å–æ–≤)\n\n'
            '*‚öîÔ∏è –†–ï–ñ–ò–ú –ë–ò–¢–í–´:*\n'
            '‚Ä¢ –°–æ–∑–¥–∞–π –±–∏—Ç–≤—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Å—å\n'
            '‚Ä¢ –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–µ –∂–µ –≤–æ–ø—Ä–æ—Å—ã\n'
            '‚Ä¢ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç +5 –±–∞–ª–ª–æ–≤!\n\n'
            'üí° –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç ‚Äî 10 —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤!',
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')]]),
            parse_mode='Markdown'
        )
    
    elif query.data == 'start_test':
        await choose_level(update, context, is_callback=True)
    
    elif query.data == 'battle_menu':
        await show_battle_menu(query)
    
    elif query.data == 'leaderboard':
        await show_general_leaderboard(query, 0)
    
    elif query.data == 'my_stats':
        await show_my_stats(query)

# ==========================================
# ‚öîÔ∏è –†–ï–ñ–ò–ú –ë–ò–¢–í–´
# ==========================================

async def show_battle_menu(query):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –±–∏—Ç–≤—ã"""
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∏—Ç–≤—ã
    available_battles = []
    for battle_id, battle in pending_battles.items():
        if battle["status"] == "waiting":
            creator_name = battle.get("creator_name", "–ò–≥—Ä–æ–∫")
            available_battles.append((battle_id, creator_name))
    
    keyboard = [
        [InlineKeyboardButton("üÜï –°–æ–∑–¥–∞—Ç—å –±–∏—Ç–≤—É", callback_data='create_battle')],
    ]
    
    if available_battles:
        for battle_id, creator_name in available_battles[:5]:  # –ú–∞–∫—Å–∏–º—É–º 5 –±–∏—Ç–≤
            keyboard.append([
                InlineKeyboardButton(f"‚öîÔ∏è vs {creator_name}", callback_data=f'join_battle_{battle_id}')
            ])
    
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')])
    
    text = '‚öîÔ∏è *–†–ï–ñ–ò–ú –ë–ò–¢–í–´*\n\n'
    text += 'üéØ –°–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏!\n'
    text += '‚Ä¢ –û–±–∞ –æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n'
    text += '‚Ä¢ –ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç –ª—É—á—à–µ\n'
    text += '‚Ä¢ –ü–æ–±–µ–¥–∞ = +5 –±–∞–ª–ª–æ–≤, –Ω–∏—á—å—è = +2\n\n'
    
    if available_battles:
        text += f'üìã *–î–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∏—Ç–≤:* {len(available_battles)}\n'
    else:
        text += 'üìã *–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∏—Ç–≤*\n–°–æ–∑–¥–∞–π —Å–≤–æ—é!\n'
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

async def create_battle(update: Update, context):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±–∏—Ç–≤—É"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    user_name = query.from_user.first_name
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –±–∏—Ç–≤—ã
    battle_id = f"battle_{user_id}_{int(time.time())}"
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –±–∏—Ç–≤—ã
    battle_qs = random.sample(battle_questions, 10)
    
    pending_battles[battle_id] = {
        "creator_id": user_id,
        "creator_name": user_name,
        "questions": battle_qs,
        "status": "waiting",
        "creator_score": 0,
        "creator_answers": [],
        "creator_time": 0,
        "opponent_id": None,
        "opponent_name": None,
        "opponent_score": 0,
        "opponent_answers": [],
        "opponent_time": 0,
        "created_at": time.time()
    }
    
    keyboard = [
        [InlineKeyboardButton("‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –æ—Ç–≤–µ—á–∞—Ç—å", callback_data=f'start_battle_{battle_id}_creator')],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –±–∏—Ç–≤—É", callback_data=f'cancel_battle_{battle_id}')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='battle_menu')]
    ]
    
    await query.edit_message_text(
        '‚öîÔ∏è *–ë–ò–¢–í–ê –°–û–ó–î–ê–ù–ê!*\n\n'
        f'üÜî ID: `{battle_id[-8:]}`\n\n'
        '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...\n'
        '–ò–ª–∏ –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—á–∞—Ç—å –ø–µ—Ä–≤—ã–º!\n\n'
        '_–ë–∏—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç_',
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

async def join_battle(update: Update, context):
    """–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –±–∏—Ç–≤–µ"""
    query = update.callback_query
    await query.answer()
    
    battle_id = query.data.replace('join_battle_', '')
    user_id = query.from_user.id
    user_name = query.from_user.first_name
    
    if battle_id not in pending_battles:
        await query.edit_message_text(
            '‚ùå –ë–∏—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.',
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='battle_menu')]])
        )
        return
    
    battle = pending_battles[battle_id]
    
    if battle["creator_id"] == user_id:
        await query.answer("–ù–µ–ª—å–∑—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–≤–æ–µ–π –±–∏—Ç–≤–µ!", show_alert=True)
        return
    
    if battle["opponent_id"] is not None:
        await query.answer("–ö —ç—Ç–æ–π –±–∏—Ç–≤–µ —É–∂–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –¥—Ä—É–≥–æ–π –∏–≥—Ä–æ–∫!", show_alert=True)
        return
    
    # –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è
    battle["opponent_id"] = user_id
    battle["opponent_name"] = user_name
    battle["status"] = "in_progress"
    
    keyboard = [
        [InlineKeyboardButton("‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –æ—Ç–≤–µ—á–∞—Ç—å", callback_data=f'start_battle_{battle_id}_opponent')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='battle_menu')]
    ]
    
    await query.edit_message_text(
        f'‚öîÔ∏è *–ë–ò–¢–í–ê –ù–ê–ß–ê–õ–ê–°–¨!*\n\n'
        f'üë§ –¢—ã vs üë§ {battle["creator_name"]}\n\n'
        'üìù 10 –≤–æ–ø—Ä–æ—Å–æ–≤\n'
        '‚è± –í—Ä–µ–º—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è!\n\n'
        '–ù–∞–∂–º–∏ "–ù–∞—á–∞—Ç—å –æ—Ç–≤–µ—á–∞—Ç—å"',
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

async def start_battle_questions(update: Update, context):
    """–ù–∞—á–∞—Ç—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –±–∏—Ç–≤—ã"""
    query = update.callback_query
    await query.answer()
    
    data_parts = query.data.replace('start_battle_', '').rsplit('_', 1)
    battle_id = data_parts[0]
    role = data_parts[1]  # creator –∏–ª–∏ opponent
    
    if battle_id not in pending_battles:
        await query.edit_message_text("‚ùå –ë–∏—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return
    
    battle = pending_battles[battle_id]
    user_id = query.from_user.id
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ user_data
    user_data[user_id] = {
        "battle_id": battle_id,
        "role": role,
        "questions": battle["questions"],
        "current_question": 0,
        "correct_answers": 0,
        "start_time": time.time(),
        "is_battle": True
    }
    
    await query.edit_message_text(
        f'‚öîÔ∏è *–ë–ò–¢–í–ê: –í–æ–ø—Ä–æ—Å 1/10*\n\n'
        f'–ù–∞—á–∏–Ω–∞–µ–º! –£–¥–∞—á–∏! üçÄ',
        parse_mode='Markdown'
    )
    
    await send_battle_question(query.message, user_id)
    return BATTLE_ANSWERING

async def send_battle_question(message, user_id):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –±–∏—Ç–≤—ã"""
    data = user_data[user_id]
    q_num = data["current_question"]
    
    if q_num >= len(data["questions"]):
        await finish_battle_for_user(message, user_id)
        return
    
    q = data["questions"][q_num]
    keyboard = [[option] for option in q["options"]]
    
    await message.reply_text(
        f'‚öîÔ∏è *–í–æ–ø—Ä–æ—Å {q_num + 1}/10*\n\n{q["question"]}',
        reply_markup=ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True),
        parse_mode='Markdown'
    )

async def battle_answer(update: Update, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∏—Ç–≤–µ"""
    user_id = update.effective_user.id
    
    if user_id not in user_data or not user_data[user_id].get("is_battle"):
        return await answer(update, context)  # –û–±—ã—á–Ω—ã–π —Ç–µ—Å—Ç
    
    data = user_data[user_id]
    q_num = data["current_question"]
    q = data["questions"][q_num]
    user_answer = update.message.text
    
    try:
        answer_index = q["options"].index(user_answer)
        if answer_index == q["correct"]:
            data["correct_answers"] += 1
        await update.message.reply_text("‚úì", reply_markup=ReplyKeyboardRemove())
    except ValueError:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞")
        return BATTLE_ANSWERING
    
    data["current_question"] += 1
    
    if data["current_question"] < len(data["questions"]):
        await send_battle_question(update.message, user_id)
        return BATTLE_ANSWERING
    else:
        await finish_battle_for_user(update.message, user_id)
        return ConversationHandler.END

async def finish_battle_for_user(message, user_id):
    """–ó–∞–≤–µ—Ä—à–∏—Ç—å –±–∏—Ç–≤—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = user_data[user_id]
    battle_id = data["battle_id"]
    role = data["role"]
    time_taken = time.time() - data["start_time"]
    score = data["correct_answers"]
    
    if battle_id not in pending_battles:
        await message.reply_text("‚ùå –ë–∏—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return
    
    battle = pending_battles[battle_id]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if role == "creator":
        battle["creator_score"] = score
        battle["creator_time"] = time_taken
        battle["creator_finished"] = True
    else:
        battle["opponent_score"] = score
        battle["opponent_time"] = time_taken
        battle["opponent_finished"] = True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫–æ–Ω—á–∏–ª–∏ –ª–∏ –æ–±–∞
    creator_done = battle.get("creator_finished", False)
    opponent_done = battle.get("opponent_finished", False)
    
    if creator_done and opponent_done:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        await show_battle_results(message, battle_id)
    else:
        await message.reply_text(
            f'‚úÖ *–¢—ã –∑–∞–∫–æ–Ω—á–∏–ª!*\n\n'
            f'üìä –¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}/10\n'
            f'‚è± –í—Ä–µ–º—è: {format_time(time_taken)}\n\n'
            '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...',
            parse_mode='Markdown',
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –í –º–µ–Ω—é", callback_data='back_to_main')]])
        )

async def show_battle_results(message, battle_id):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–∏—Ç–≤—ã"""
    if battle_id not in pending_battles:
        return
    
    battle = pending_battles[battle_id]
    
    creator_score = battle["creator_score"]
    opponent_score = battle["opponent_score"]
    creator_time = battle["creator_time"]
    opponent_time = battle["opponent_time"]
    creator_name = battle["creator_name"]
    opponent_name = battle.get("opponent_name", "–°–æ–ø–µ—Ä–Ω–∏–∫")
    creator_id = battle["creator_id"]
    opponent_id = battle["opponent_id"]
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    if creator_score > opponent_score:
        winner = "creator"
        winner_name = creator_name
    elif opponent_score > creator_score:
        winner = "opponent"
        winner_name = opponent_name
    elif creator_time < opponent_time:
        winner = "creator"
        winner_name = creator_name
    elif opponent_time < creator_time:
        winner = "opponent"
        winner_name = opponent_name
    else:
        winner = "draw"
        winner_name = None
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if winner == "creator":
        update_battle_stats(creator_id, "win")
        update_battle_stats(opponent_id, "lose")
    elif winner == "opponent":
        update_battle_stats(creator_id, "lose")
        update_battle_stats(opponent_id, "win")
    else:
        update_battle_stats(creator_id, "draw")
        update_battle_stats(opponent_id, "draw")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result_text = '‚öîÔ∏è *–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ë–ò–¢–í–´*\n\n'
    
    if winner == "draw":
        result_text += 'ü§ù *–ù–ò–ß–¨–Ø!*\n\n'
    else:
        result_text += f'üèÜ *–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: {winner_name}!*\n\n'
    
    result_text += f'üë§ *{creator_name}*\n'
    result_text += f'   üìä {creator_score}/10 ‚Ä¢ ‚è± {format_time(creator_time)}\n\n'
    result_text += f'üë§ *{opponent_name}*\n'
    result_text += f'   üìä {opponent_score}/10 ‚Ä¢ ‚è± {format_time(opponent_time)}\n\n'
    
    if winner != "draw":
        result_text += f'üíé *+5 –±–∞–ª–ª–æ–≤* –ø–æ–±–µ–¥–∏—Ç–µ–ª—é!\n'
    else:
        result_text += f'üíé *+2 –±–∞–ª–ª–∞* –∫–∞–∂–¥–æ–º—É!\n'
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –ù–æ–≤–∞—è –±–∏—Ç–≤–∞", callback_data='battle_menu')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –í –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    
    await message.reply_text(
        result_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )
    
    # –£–¥–∞–ª—è–µ–º –±–∏—Ç–≤—É
    del pending_battles[battle_id]

async def cancel_battle(update: Update, context):
    """–û—Ç–º–µ–Ω–∏—Ç—å –±–∏—Ç–≤—É"""
    query = update.callback_query
    await query.answer()
    
    battle_id = query.data.replace('cancel_battle_', '')
    
    if battle_id in pending_battles:
        del pending_battles[battle_id]
    
    await query.edit_message_text(
        '‚ùå –ë–∏—Ç–≤–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.',
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='battle_menu')]])
    )

# ==========================================
# üìä –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# ==========================================

async def show_my_stats(query):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    user_id = query.from_user.id
    position, entry = get_user_position(user_id)
    
    if not entry:
        text = 'üìä *–ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê*\n\n–í—ã –µ—â—ë –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç—ã.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /test —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!'
        keyboard = [[InlineKeyboardButton("üéØ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data='start_test')],
                    [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')]]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')
        return
    
    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    days_playing = calculate_days_playing(entry.get("first_play_date", datetime.now().strftime("%Y-%m-%d")))
    total_tests = entry.get("total_tests", 0)
    total_questions = entry.get("total_questions_answered", 0)
    total_correct = entry.get("total_correct_answers", 0)
    total_accuracy = calculate_accuracy(total_correct, total_questions)
    avg_time = entry.get("total_time_spent", 0) / max(total_tests, 1)
    
    # –ë–∏—Ç–≤—ã
    battles_played = entry.get("battles_played", 0)
    battles_won = entry.get("battles_won", 0)
    battles_lost = entry.get("battles_lost", 0)
    battles_draw = entry.get("battles_draw", 0)
    
    text = 'üìä *–ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê*\n\n'
    text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
    text += 'üë§ *–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø*\n'
    text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
    text += f'üèÖ –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ: *#{position}*\n'
    text += f'üíé –í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: *{entry.get("total_points", 0)}*\n'
    text += f'üìÖ –î–Ω–µ–π –≤ –∏–≥—Ä–µ: *{days_playing}*\n'
    text += f'üéØ –¢–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: *{total_tests}*\n'
    text += f'üìù –í–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç–≤–µ—á–µ–Ω–æ: *{total_questions}*\n'
    text += f'‚úÖ –û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å: *{total_accuracy}%*\n'
    text += f'‚è± –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞: *{format_time(avg_time)}*\n\n'
    
    text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
    text += '‚öîÔ∏è *–ë–ò–¢–í–´*\n'
    text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
    text += f'üéÆ –°—ã–≥—Ä–∞–Ω–æ: *{battles_played}*\n'
    text += f'üèÜ –ü–æ–±–µ–¥: *{battles_won}*\n'
    text += f'üíî –ü–æ—Ä–∞–∂–µ–Ω–∏–π: *{battles_lost}*\n'
    text += f'ü§ù –ù–∏—á—å–∏—Ö: *{battles_draw}*\n'
    if battles_played > 0:
        win_rate = round((battles_won / battles_played) * 100)
        text += f'üìà –í–∏–Ω—Ä–µ–π—Ç: *{win_rate}%*\n'
    text += '\n'
    
    text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
    text += 'üìö *–ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú*\n'
    text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
    
    categories = [
        ("easy", "üü¢ –õ—ë–≥–∫–∏–π"),
        ("medium", "üü° –°—Ä–µ–¥–Ω–∏–π"),
        ("hard", "üî¥ –°–ª–æ–∂–Ω—ã–π"),
        ("nero", "üëë –ù–µ—Ä–æ–Ω"),
        ("geography", "üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è")
    ]
    
    for key, name in categories:
        attempts = entry.get(f"{key}_attempts", 0)
        if attempts > 0:
            correct = entry.get(f"{key}_correct", 0)
            total = entry.get(f"{key}_total", 0)
            accuracy = calculate_accuracy(correct, total)
            best = entry.get(f"{key}_best_score", 0)
            text += f'{name}: *{accuracy}%* (–ª—É—á—à–∏–π: {best}/10)\n'
        else:
            text += f'{name}: _–Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ_\n'
    
    keyboard = [
        [InlineKeyboardButton("üéØ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data='start_test')],
        [InlineKeyboardButton("‚öîÔ∏è –ë–∏—Ç–≤–∞", callback_data='battle_menu')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')

# –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
async def show_general_leaderboard(query, page=0):
    users = get_leaderboard_page(page)
    total_users = get_total_users()
    
    if not users:
        text = 'üèÜ *–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í*\n\n–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª —Ç–µ—Å—Ç—ã.\n–ë—É–¥—å –ø–µ—Ä–≤—ã–º! üöÄ'
    else:
        text = f'üèÜ *–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í* (–°—Ç—Ä. {page + 1})\n\n'
        start_rank = (page * 10) + 1
        
        for i, entry in enumerate(users, start_rank):
            medal = ""
            if i == 1: medal = "ü•á"
            elif i == 2: medal = "ü•à"
            elif i == 3: medal = "ü•â"
            
            name = entry.get('first_name', 'Unknown')[:15]
            points = entry.get("total_points", 0)
            tests = entry.get("total_tests", 0)
            battles = entry.get("battles_won", 0)
            
            text += f'{medal} *{i}.* {name}\n'
            text += f'   üíé {points} ‚Ä¢ üéØ {tests} —Ç–µ—Å—Ç–æ–≤ ‚Ä¢ ‚öîÔ∏è {battles} –ø–æ–±–µ–¥\n\n'
    
    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f'leaderboard_page_{page-1}'))
    if (page + 1) * 10 < total_users:
        nav_buttons.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f'leaderboard_page_{page+1}'))
    
    keyboard = []
    if nav_buttons:
        keyboard.append(nav_buttons)
    keyboard.append([InlineKeyboardButton("üéØ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data='start_test')])
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –í –º–µ–Ω—é", callback_data='back_to_main')])
    
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')

# –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async def back_to_main(update: Update, context):
    query = update.callback_query
    await query.answer()
    
    keyboard = [
        [InlineKeyboardButton("üìñ –û –±–æ—Ç–µ", callback_data='about')],
        [InlineKeyboardButton("üéØ –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data='start_test')],
        [InlineKeyboardButton("‚öîÔ∏è –†–µ–∂–∏–º –±–∏—Ç–≤—ã", callback_data='battle_menu')],
        [InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data='leaderboard')],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='my_stats')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        'üìñ *–ë–ò–ë–õ–ï–ô–°–ö–ò–ô –¢–ï–°–¢-–ë–û–¢*\n\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:',
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è
async def choose_level(update, context, is_callback=False):
    keyboard = [
        [InlineKeyboardButton("üü¢ –õ—ë–≥–∫–∏–π (1 –±–∞–ª–ª)", callback_data='level_easy')],
        [InlineKeyboardButton("üü° –°—Ä–µ–¥–Ω–∏–π (2 –±–∞–ª–ª–∞)", callback_data='level_medium')],
        [InlineKeyboardButton("üî¥ –°–ª–æ–∂–Ω—ã–π (3 –±–∞–ª–ª–∞)", callback_data='level_hard')],
        [InlineKeyboardButton("üëë –ù–µ—Ä–æ–Ω (2 –±–∞–ª–ª–∞)", callback_data='level_nero')],
        [InlineKeyboardButton("üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è (2 –±–∞–ª–ª–∞)", callback_data='level_geography')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    text = ('üéØ *–í–´–ë–ï–†–ò –ö–ê–¢–ï–ì–û–†–ò–Æ*\n\n'
            'üìö *–ü–æ 1 –ü–µ—Ç—Ä–∞:*\n'
            'üü¢ –õ—ë–≥–∫–∏–π ‚Ä¢ üü° –°—Ä–µ–¥–Ω–∏–π ‚Ä¢ üî¥ –°–ª–æ–∂–Ω—ã–π\n\n'
            'üìú *–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ:*\n'
            'üëë –ü—Ä–∞–≤–ª–µ–Ω–∏–µ –ù–µ—Ä–æ–Ω–∞\n'
            'üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∑–µ–º–ª–∏')
    
    if is_callback and hasattr(update, 'callback_query'):
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='Markdown')

# –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞
async def level_selected(update: Update, context):
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    
    if query.data == 'back_to_main':
        await back_to_main(update, context)
        return ConversationHandler.END
    
    level_config = {
        'level_easy': (easy_questions, "üü¢ –õ—ë–≥–∫–∏–π", "easy"),
        'level_medium': (medium_questions, "üü° –°—Ä–µ–¥–Ω–∏–π", "medium"),
        'level_hard': (hard_questions, "üî¥ –°–ª–æ–∂–Ω—ã–π", "hard"),
        'level_nero': (nero_questions, "üëë –ü—Ä–∞–≤–ª–µ–Ω–∏–µ –ù–µ—Ä–æ–Ω–∞", "nero"),
        'level_geography': (geography_questions, "üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∑–µ–º–ª–∏", "geography"),
    }
    
    if query.data not in level_config:
        return ConversationHandler.END
    
    questions_pool, level_name, level_key = level_config[query.data]
    questions = random.sample(questions_pool, min(10, len(questions_pool)))
    
    user_data[user_id] = {
        "questions": questions,
        "level_name": level_name,
        "level_key": level_key,
        "current_question": 0,
        "correct_answers": 0,
        "wrong_answers": [],
        "start_time": time.time(),
        "is_battle": False
    }
    
    await query.edit_message_text(
        f'*{level_name}*\n\nüìù –í–æ–ø—Ä–æ—Å–æ–≤: {len(questions)}\n–ù–∞—á–∏–Ω–∞–µ–º! ‚è±',
        parse_mode='Markdown'
    )
    await send_question(query.message, user_id)
    return ANSWERING

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
async def send_question(message, user_id):
    data = user_data[user_id]
    q_num = data["current_question"]
    total = len(data["questions"])
    
    if q_num >= total:
        await show_results(message, user_id)
        return ConversationHandler.END
    
    q = data["questions"][q_num]
    keyboard = [[option] for option in q["options"]]
    
    await message.reply_text(
        f'*–í–æ–ø—Ä–æ—Å {q_num + 1}/{total}*\n\n{q["question"]}',
        reply_markup=ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True),
        parse_mode='Markdown'
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
async def answer(update: Update, context):
    user_id = update.effective_user.id
    
    if user_id not in user_data:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π /test —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å")
        return ConversationHandler.END
    
    data = user_data[user_id]
    
    # –ï—Å–ª–∏ —ç—Ç–æ –±–∏—Ç–≤–∞
    if data.get("is_battle"):
        return await battle_answer(update, context)
    
    q_num = data["current_question"]
    q = data["questions"][q_num]
    user_answer = update.message.text
    
    try:
        answer_index = q["options"].index(user_answer)
        if answer_index == q["correct"]:
            data["correct_answers"] += 1
        else:
            data["wrong_answers"].append({
                "question": q["question"],
                "your_answer": user_answer,
                "correct_answer": q["options"][q["correct"]],
                "explanation": q["explanation"]
            })
        await update.message.reply_text("‚úì –ü—Ä–∏–Ω—è—Ç–æ", reply_markup=ReplyKeyboardRemove())
    except ValueError:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤")
        return ANSWERING
    
    data["current_question"] += 1
    
    if data["current_question"] < len(data["questions"]):
        await send_question(update.message, user_id)
        return ANSWERING
    else:
        await show_results(update.message, user_id)
        return ConversationHandler.END

# –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
async def show_results(message, user_id):
    data = user_data[user_id]
    score = data["correct_answers"]
    total = len(data["questions"])
    percentage = (score / total) * 100
    time_taken = time.time() - data["start_time"]
    user = message.from_user
    
    add_to_leaderboard(user_id, user.username, user.first_name, data["level_key"], score, total, time_taken)
    
    position, entry = get_user_position(user_id)
    points_per_question = {"easy": 1, "medium": 2, "hard": 3, "nero": 2, "geography": 2}
    earned_points = score * points_per_question.get(data["level_key"], 1)
    
    if percentage >= 90: grade = "–û—Ç–ª–∏—á–Ω–æ! üåü"
    elif percentage >= 70: grade = "–•–æ—Ä–æ—à–æ! üëç"
    elif percentage >= 50: grade = "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ üìñ"
    else: grade = "–ù—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å üìö"
    
    result_text = f'üèÜ *–†–ï–ó–£–õ–¨–¢–ê–¢–´*\n\n'
    result_text += f'*–ö–∞—Ç–µ–≥–æ—Ä–∏—è:* {data["level_name"]}\n'
    result_text += f'*–ü—Ä–∞–≤–∏–ª—å–Ω–æ:* {score}/{total} ({percentage:.0f}%)\n'
    result_text += f'*–ë–∞–ª–ª—ã:* +{earned_points} üíé\n'
    result_text += f'*–í—Ä–µ–º—è:* {format_time(time_taken)}\n'
    result_text += f'*–ü–æ–∑–∏—Ü–∏—è:* #{position}\n'
    result_text += f'*–û—Ü–µ–Ω–∫–∞:* {grade}\n\n'
    
    if data["wrong_answers"]:
        result_text += '‚ùå *–û–®–ò–ë–ö–ò:*\n\n'
        for i, wrong in enumerate(data["wrong_answers"][:3], 1):  # –ú–∞–∫—Å–∏–º—É–º 3 –æ—à–∏–±–∫–∏
            result_text += f'*{i}. {wrong["question"][:50]}...*\n'
            result_text += f'‚úÖ {wrong["correct_answer"]}\n\n'
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –ï—â—ë —Ä–∞–∑", callback_data='start_test')],
        [InlineKeyboardButton("‚öîÔ∏è –ë–∏—Ç–≤–∞", callback_data='battle_menu')],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='my_stats')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ú–µ–Ω—é", callback_data='back_to_main')]
    ]
    
    await message.reply_text(result_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')

# –ö–æ–º–∞–Ω–¥—ã
async def test_command(update: Update, context):
    await choose_level(update, context, is_callback=False)
    return CHOOSING_LEVEL

async def cancel(update: Update, context):
    await update.message.reply_text('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ.', reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–∏—Ç–≤
def cleanup_old_battles():
    """–£–¥–∞–ª–∏—Ç—å –±–∏—Ç–≤—ã —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç"""
    current_time = time.time()
    to_delete = []
    for battle_id, battle in pending_battles.items():
        if current_time - battle.get("created_at", 0) > 600:  # 10 –º–∏–Ω—É—Ç
            to_delete.append(battle_id)
    for bid in to_delete:
        del pending_battles[bid]

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    BOT_TOKEN = "8134773553:AAF4DWLR7DBDolkigso_ZgXd4Ml_90YaaK8"
    
    app = Application.builder().token(BOT_TOKEN).build()
    
    # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('test', test_command),
            CallbackQueryHandler(level_selected, pattern='^level_'),
            CallbackQueryHandler(start_battle_questions, pattern='^start_battle_'),
        ],
        states={
            CHOOSING_LEVEL: [CallbackQueryHandler(level_selected)],
            ANSWERING: [MessageHandler(filters.TEXT & ~filters.COMMAND, answer)],
            BATTLE_ANSWERING: [MessageHandler(filters.TEXT & ~filters.COMMAND, battle_answer)],
        },
        fallbacks=[
            CommandHandler('cancel', cancel),
            CallbackQueryHandler(back_to_main, pattern='^back_to_main$'),
        ],
        allow_reentry=True
    )
    
    app.add_handler(conv_handler)
    app.add_handler(CommandHandler("start", start))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–∏—Ç–≤
    app.add_handler(CallbackQueryHandler(create_battle, pattern='^create_battle$'))
    app.add_handler(CallbackQueryHandler(join_battle, pattern='^join_battle_'))
    app.add_handler(CallbackQueryHandler(cancel_battle, pattern='^cancel_battle_'))
    
    # –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    app.add_handler(CallbackQueryHandler(button_handler, pattern=r'^(about|start_test|battle_menu|leaderboard|my_stats|leaderboard_page_\d+)$'))
    app.add_handler(CallbackQueryHandler(back_to_main, pattern='^back_to_main$'))
    
    print('ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!')
    print('üìö 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–µ—Å—Ç–æ–≤')
    print('‚öîÔ∏è –†–µ–∂–∏–º –±–∏—Ç–≤—ã –≤–∫–ª—é—á—ë–Ω')
    print('üìä –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞')
    
    app.run_polling()

if __name__ == '__main__':
    main()
